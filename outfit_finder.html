<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outfit Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Outfit Finder</h1>
                <p class="text-gray-600 mt-2">Upload an image of an outfit to find similar clothing items online.</p>
            </header>

            <div class="mb-6">
                <label for="image-upload" class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span>Upload a file</span>
                                <input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/*">
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                    </div>
                </div>
            </div>
            
            <div id="image-preview-container" class="mb-6 hidden">
                <img id="image-preview" src="#" alt="Image Preview" class="max-h-60 mx-auto rounded-lg shadow-md"/>
            </div>

            <div class="text-center">
                <button id="find-button" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 disabled:cursor-not-allowed" disabled>
                    Find Outfit
                </button>
            </div>

            <div id="loader" class="hidden my-8 flex justify-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
            </div>
            
            <div id="results" class="mt-8"></div>
            <div id="error-message" class="hidden mt-4 text-center p-4 bg-red-100 text-red-700 rounded-lg"></div>

        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const findButton = document.getElementById('find-button');
        const resultsDiv = document.getElementById('results');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        let base64ImageData = null;

        // Event listener for image upload
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    base64ImageData = e.target.result.split(',')[1];
                    findButton.disabled = false;
                    resultsDiv.innerHTML = '';
                    errorMessage.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Event listener for the find button
        findButton.addEventListener('click', async () => {
            if (!base64ImageData) {
                showError("Please upload an image first.");
                return;
            }

            loader.classList.remove('hidden');
            resultsDiv.innerHTML = '';
            errorMessage.classList.add('hidden');
            findButton.disabled = true;

            try {
                await findOutfit(base64ImageData);
            } catch (error) {
                console.error("Error finding outfit:", error);
                showError("Sorry, something went wrong. Please try again.");
            } finally {
                loader.classList.add('hidden');
                findButton.disabled = false;
            }
        });
        
        /**
         * Calls the Gemini API to find similar outfits.
         * @param {string} imageData - The base64 encoded image data.
         */
        async function findOutfit(imageData) {
            const prompt = `
                Analyze the following image of an outfit. Identify the main clothing items (e.g., shirt, pants, shoes, accessories). 
                For each item, provide very specific and detailed search terms that include brand names, specific styles, colors, materials, and any logos or text visible on the clothing.
                The output should be a JSON object.
                The JSON object should have a key "outfit_items", which is an array of objects.
                Each object in the array should represent a clothing item and have the following properties:
                - "item_name": A detailed string describing the item (e.g., "White NC State Logo Crewneck Sweatshirt", "Blue Distressed Skinny Jeans").
                - "search_terms": An array of very specific search terms that include:
                    * Brand names if visible (e.g., "Nike", "Adidas", "NC State", "University name")
                    * Specific style details (e.g., "crewneck", "hoodie", "v-neck", "distressed", "skinny fit")
                    * Color descriptions (e.g., "white", "navy blue", "black")
                    * Material if visible (e.g., "cotton", "polyester", "denim")
                    * Any logos, text, or graphics visible
                    * Examples: ["NC State white crewneck sweatshirt", "NC State University sweatshirt white", "NC State logo crewneck"]
                - "category": The category of clothing (e.g., "shirt", "pants", "shoes", "accessories").
                - "brand": The brand name if visible, otherwise "unknown".
                - "color": The primary color of the item.
                - "style": The specific style or cut of the item.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: imageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            const apiKey = "AIzaSyBxA2rg4CbejIa5YbA-oKfwaaVHCHdSrTE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    await searchAndDisplayResults(parsedJson);
                } else {
                    showError("Could not find any similar items. The model might not have been able to process the image.");
                }
            } catch (error) {
                console.error('API Error:', error);
                showError("Failed to fetch results. Please check your connection and try again.");
            }
        }

        /**
         * Searches for products on different websites and displays results.
         * @param {object} data - The parsed JSON data from the API.
         */
        async function searchAndDisplayResults(data) {
            if (!data.outfit_items || data.outfit_items.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-gray-600">No similar items found.</p>';
                return;
            }

            // Define the stores to search
            const stores = [
                { name: "Amazon", searchUrl: "https://www.amazon.com/s?k=" },
                { name: "ASOS", searchUrl: "https://www.asos.com/search/?q=" },
                { name: "H&M", searchUrl: "https://www2.hm.com/en_us/search-results.html?q=" },
                { name: "Zara", searchUrl: "https://www.zara.com/us/en/search?searchTerm=" },
                { name: "Shein", searchUrl: "https://us.shein.com/search?keyword=" },
                { name: "Nordstrom", searchUrl: "https://www.nordstrom.com/sr?origin=keywordsearch&keyword=" },
                { name: "Forever 21", searchUrl: "https://www.forever21.com/us/shop/search?q=" },
                { name: "American Eagle", searchUrl: "https://www.ae.com/us/en/search?q=" }
            ];

            let html = '<h2 class="text-2xl font-bold mb-4 text-gray-800">Shop the Look</h2>';
            html += '<div class="space-y-6">';

            for (const item of data.outfit_items) {
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">${item.item_name}</h3>
                        <div class="mb-3 text-sm text-gray-600">
                            ${item.brand && item.brand !== 'unknown' ? `<span class="mr-3"><strong>Brand:</strong> ${item.brand}</span>` : ''}
                            ${item.color ? `<span class="mr-3"><strong>Color:</strong> ${item.color}</span>` : ''}
                            ${item.style ? `<span><strong>Style:</strong> ${item.style}</span>` : ''}
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                // Use the most specific search term for each store
                const searchTerm = item.search_terms && item.search_terms.length > 0 ? 
                    item.search_terms[0] : item.item_name.toLowerCase();
                
                stores.forEach(store => {
                    const searchUrl = store.searchUrl + encodeURIComponent(searchTerm);
                    html += `
                        <a href="${searchUrl}" target="_blank" rel="noopener noreferrer" class="block bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 overflow-hidden">
                            <div class="aspect-w-1 aspect-h-1 bg-gray-200 flex items-center justify-center">
                                <div class="text-center p-4">
                                    <div class="text-2xl mb-2">🛍️</div>
                                    <div class="text-sm text-gray-600">Searching ${store.name}</div>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-indigo-600">${store.name}</span>
                                    <span class="text-sm text-gray-500">Search Results</span>
                                </div>
                                <div class="mt-2 flex items-center text-sm text-gray-600">
                                    <span>View Search Results</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </div>
                            </div>
                        </a>
                    `;
                });

                html += `</div></div>`;
            }

            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        /**
         * Displays an error message.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

    </script>

</body>
</html>
